name: Intelligent Playwright Test Automation

on:
  workflow_dispatch:
    inputs:
      website_url:
        description: "Website URL to test"
        required: true
        type: string
        default: ""
      test_suite_name:
        description: "Test suite name (e.g., login, checkout)"
        required: true
        type: string
  push:
    branches: [test_pipeline]

env:
  NODE_VERSION: "20"
  TIMESTAMP: ${{ github.run_number }}-${{ github.run_attempt }}
  TEST_SUITE_NAME: "WebForms"
  WEBSITE_URL: https://demos.telerik.com/aspnet-ajax/grid/examples/overview/defaultcs.aspx

jobs:
  # =========================================
  # STEP 1-5: Explore & Generate
  # =========================================
  explore-and-generate:
    name: ğŸ” Explore & Generate Tests
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Set Environment Variables
        run: |
          # echo "WEBSITE_URL=${{ inputs.website_url }}" >> $GITHUB_ENV
          # echo "TEST_SUITE_NAME=${{ inputs.test_suite_name }}" >> $GITHUB_ENV
          echo "WEBSITE_URL=${{ env.WEBSITE_URL }}" >> $GITHUB_ENV
          echo "TEST_SUITE_NAME=${{ env.TEST_SUITE_NAME }}" >> $GITHUB_ENV

      - name: ğŸ”„ Normalize Test Suite Name
        id: normalize
        run: |
          NORMALIZED_NAME=$(echo "${{ env.TEST_SUITE_NAME }}" | sed 's/ /_/g')
          echo "normalized_name=$NORMALIZED_NAME" >> $GITHUB_OUTPUT
          echo "Original: ${{ env.TEST_SUITE_NAME }}"
          echo "Normalized: $NORMALIZED_NAME"

      - name: ğŸ“¦ Install Dependencies (or restore from cache)
        run: |
          npm install
          npx playwright install --with-deps chromium

      - name: ğŸ¤– STEP 1 - Explore Website
        id: explore
        run: |
          echo ""
          echo "================================================"
          echo "ğŸ” STEP 1: WEBSITE EXPLORATION"
          echo "================================================"
          echo "ğŸ“ Target URL: ${{ env.WEBSITE_URL }}"
          echo "ğŸ“ Test Suite: ${{ env.TEST_SUITE_NAME }}"
          echo ""
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] Starting exploration..."

          cat > explore-website.js << 'EXPLORESCRIPT'
          const { chromium } = require('@playwright/test');

          (async () => {
            const startTime = Date.now();
            const timestamp = () => new Date().toISOString().substring(0, 19).replace('T', ' ');
            
            console.log(`[${timestamp()}] ğŸŒ Launching browser...`);
            
            const browser = await chromium.launch();
            const page = await browser.newPage();
            
            console.log(`[${timestamp()}] ğŸ“ Navigating to: ${{ env.WEBSITE_URL }}`);
            await page.goto('${{ env.WEBSITE_URL }}');
            
            console.log(`[${timestamp()}] âœ“ Page loaded`);
            console.log(`[${timestamp()}] ğŸ“¸ Taking snapshot...`);
            
            await page.screenshot({ path: 'exploration-snapshot.png', fullPage: true });
            
            console.log(`[${timestamp()}] ğŸ” Analyzing page structure...`);
            
            const elements = await page.evaluate(() => {
              const inputs = document.querySelectorAll('input, textarea, select');
              const buttons = document.querySelectorAll('button, [type="submit"]');
              const links = document.querySelectorAll('a[href]');
              
              return {
                inputs: inputs.length,
                buttons: buttons.length,
                links: links.length,
                title: document.title,
                forms: document.querySelectorAll('form').length
              };
            });
            
            const duration = ((Date.now() - startTime) / 1000).toFixed(2);
            
            console.log(`[${timestamp()}] âœ“ Analysis complete:`);
            console.log(`   - Page Title: ${elements.title}`);
            console.log(`   - Input Fields: ${elements.inputs}`);
            console.log(`   - Buttons: ${elements.buttons}`);
            console.log(`   - Links: ${elements.links}`);
            console.log(`   - Forms: ${elements.forms}`);
            console.log(``);
            console.log(`âœ“ STEP 1 COMPLETE (${duration} seconds)`);
            
            await browser.close();
          })();
          EXPLORESCRIPT

          node explore-website.js

      - name: ğŸ¤– STEP 2 - Generate Test Cases CSV
        id: generate-csv
        run: |
          echo ""
          echo "================================================"
          echo "ğŸ“ STEP 2: GENERATING TEST CASES CSV"
          echo "================================================"

          npm run generate:csv -- \
            --url "${{ env.WEBSITE_URL }}" \
            --suite "${{ steps.normalize.outputs.normalized_name }}"

          if [ -f "test-suites/${{ steps.normalize.outputs.normalized_name }}-test-cases.csv" ]; then
            TEST_COUNT=$(tail -n +2 "test-suites/${{ steps.normalize.outputs.normalized_name }}-test-cases.csv" | wc -l)
            echo ""
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] âœ“ Generated $TEST_COUNT test cases"
            echo ""
            echo "ğŸ“Š Test Case Breakdown:"
            
            HAPPY=$(grep -c "Happy Path" "test-suites/${{ steps.normalize.outputs.normalized_name }}-test-cases.csv" || echo "0")
            NEGATIVE=$(grep -c "Negative" "test-suites/${{ steps.normalize.outputs.normalized_name }}-test-cases.csv" || echo "0")
            EDGE=$(grep -c "Edge Case" "test-suites/${{ steps.normalize.outputs.normalized_name }}-test-cases.csv" || echo "0")
            
            echo "   - Happy Path: $HAPPY cases"
            echo "   - Negative: $NEGATIVE cases"
            echo "   - Edge Cases:  $EDGE cases"
          fi

      - name: ğŸ¤– STEP 3 - Generate Locator Files
        id: generate-locators
        run: |
          echo ""
          echo "================================================"
          echo "ğŸ”‘ STEP 3: GENERATING LOCATOR FILES"
          echo "================================================"

          npm run generate:locators -- \
            --suite "${{ steps.normalize.outputs.normalized_name }}"

          echo ""

      - name: ğŸ¤– STEP 4 - Generate Page Objects
        id: generate-pages
        run: |
          echo ""
          echo "================================================"
          echo "ğŸ“„ STEP 4: GENERATING PAGE OBJECTS (OOP)"
          echo "================================================"

          npm run generate:pages -- \
            --suite "${{ steps.normalize.outputs.normalized_name }}"

          echo ""

      - name: ğŸ¤– STEP 5 - Generate Test Specs
        id: generate-tests
        run: |
          echo ""
          echo "================================================"
          echo "ğŸ§ª STEP 5: GENERATING TEST SPECIFICATIONS"
          echo "================================================"

          npm run generate:tests -- \
            --suite "${{ steps.normalize.outputs.normalized_name }}" \
            --csv "test-suites/${{ steps.normalize.outputs.normalized_name }}-test-cases.csv"

          TEST_FILES=$(find tests/test-cases -name "*${{ steps.normalize.outputs.normalized_name }}*.spec.ts" 2>/dev/null | wc -l)
          echo ""
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] âœ“ Generated $TEST_FILES test spec files"

      - name: ğŸ’¾ Commit Generated Files
        run: |
          echo ""
          echo "================================================"
          echo "ğŸ’¾ COMMITTING GENERATED FILES"
          echo "================================================"

          git config user.name "Playwright Test Generator"
          git config user.email "test-generator@github.com"

          git add test-suites/
          git add locators/
          git add tests/

          if git diff --staged --quiet; then
            echo "âš ï¸ No changes to commit"
          else
            git commit -m "Generate tests for ${{ env.TEST_SUITE_NAME }} - Explored ${{ env.WEBSITE_URL }} - Generated test cases CSV, locators, page objects, and test specs - Run #${{ github.run_number }}"
            git push
            echo "âœ“ Files committed and pushed"
          fi

          echo ""
          echo "================================================"
          echo "âœ… GENERATION PHASE COMPLETE"
          echo "================================================"

    outputs:
      # test-suite-name: ${{ env.TEST_SUITE_NAME }}
      test-suite-name: ${{ steps.normalize.outputs.normalized_name }}

  # =========================================
  # STEP 6: Run Tests
  # =========================================
  run-tests:
    name: â–¶ï¸ Run Tests
    needs: explore-and-generate
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Cache Node Modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ env.NODE_VERSION }}-

      - name: ğŸ“¦ Install Dependencies (or restore from cache)
        run: |
          npm ci
          npx playwright install --with-deps chromium

      - name: ğŸ§ª STEP 6 - Execute Tests
        id: run-tests
        run: |
          echo ""
          echo "================================================"
          echo "â–¶ï¸ STEP 6: RUNNING PLAYWRIGHT TESTS"
          echo "================================================"
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] Starting test execution..."
          echo "   - Trace:  ENABLED"
          echo "   - Screenshots: ON FAILURE"
          echo "   - Videos: ON FAILURE"
          echo ""

          npx playwright test \
            --trace on \
            --reporter=html,json,list \
            2>&1 | tee test-execution.log

          TEST_EXIT_CODE=$?

          echo ""
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] Test execution finished"

          if [ -f "test-results/results.json" ]; then
            echo ""
            echo "ğŸ“Š TEST RESULTS SUMMARY:"
            
            TOTAL=$(grep -o '"title"' test-results/results.json | wc -l)
            PASSED=$(grep -c '"ok":  true' test-results/results.json || echo "0")
            FAILED=$(grep -c '"ok": false' test-results/results.json || echo "0")
            
            echo "   Total Tests: $TOTAL"
            echo "   âœ“ Passed: $PASSED"
            echo "   âœ— Failed: $FAILED"
            
            if [ $TOTAL -gt 0 ]; then
              SUCCESS_RATE=$(awk "BEGIN {printf \"%.1f\", ($PASSED/$TOTAL)*100}")
              echo "   Success Rate: $SUCCESS_RATE%"
            fi
          fi

          echo ""
          echo "âœ“ STEP 6 COMPLETE"

          exit 0
        continue-on-error: true

      - name: ğŸ“¤ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ env.TIMESTAMP }}
          path: |
            test-results/
            playwright-report/
            test-execution.log
          retention-days: 30

    outputs:
      has-failures: ${{ steps.run-tests.outcome == 'failure' }}

  # =========================================
  # STEP 7-8: Analyze & Fix
  # =========================================
  analyze-and-fix:
    name: ğŸ” Analyze & Fix
    needs: run-tests
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Cache Node Modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ env.NODE_VERSION }}-

      - name: ğŸ“¦ Install Dependencies (or restore from cache)
        run: npm ci

      - name: ğŸ“¥ Download Test Results
        uses: actions/download-artifact@v4
        with:
          name: test-results-${{ env.TIMESTAMP }}
          path: ./

      - name: ğŸ” STEP 7 - Analyze Failures
        id: analyze
        run: |
          echo ""
          echo "================================================"
          echo "ğŸ” STEP 7: ANALYZING TEST FAILURES"
          echo "================================================"

          npm run analyze:failures

          if [ -f "analysis/failure-analysis-"*".md" ]; then
            ANALYSIS_FILE=$(ls -t analysis/failure-analysis-*.md | head -1)
            echo ""
            echo "âœ“ Analysis report generated: $ANALYSIS_FILE"
            echo ""
            echo "ğŸ“Š FAILURE ANALYSIS PREVIEW:"
            head -n 30 "$ANALYSIS_FILE"
          fi

      - name: ğŸ”§ STEP 8 - Auto-Fix Issues
        id: autofix
        run: |
          echo ""
          echo "================================================"
          echo "ğŸ”§ STEP 8: AUTO-FIX & SUGGESTIONS"
          echo "================================================"

          npm run auto-fix

          if [ -f "analysis/suggested-fixes.json" ]; then
            echo ""
            echo "ğŸ“‹ FIX SUGGESTIONS:"
            cat analysis/suggested-fixes.json | head -n 50
          fi

      - name: ğŸ’¾ Commit Analysis & Fixes
        run: |
          git config user.name "Auto-Fix Bot"
          git config user.email "auto-fix@github.com"

          git add tests/ analysis/

          if git diff --staged --quiet; then
            echo "No auto-fixes to commit"
          else
            git commit -m "Auto-fix test issues - Applied high-confidence fixes - See analysis/suggested-fixes.json - Run #${{ github.run_number }}"
            git push
            echo "âœ“ Auto-fixes committed"
          fi

  # =========================================
  # STEP 9-10: Report & Update
  # =========================================
  report-and-update:
    name: ğŸ“Š Report & Update
    needs: [explore-and-generate, run-tests, analyze-and-fix]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Cache Node Modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ env.NODE_VERSION }}-

      - name: ğŸ“¦ Install Dependencies (or restore from cache)
        run: npm ci

      - name: ğŸ“¥ Download Test Results
        uses: actions/download-artifact@v4
        with:
          name: test-results-${{ env.TIMESTAMP }}
          path: ./

      - name: ğŸ“Š STEP 9 - Generate Report
        run: |
          echo ""
          echo "================================================"
          echo "ğŸ“Š STEP 9: GENERATING TEST REPORT"
          echo "================================================"

          npm run generate:report

          REPORT_FILE=$(ls -t reports/test-report-*.html 2>/dev/null | head -1)
          if [ -n "$REPORT_FILE" ]; then
            echo ""
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] âœ“ Report generated: $REPORT_FILE"
          fi

      - name: ğŸ“ STEP 10 - Update CSV with Results
        run: |
          echo ""
          echo "================================================"
          echo "ğŸ“ STEP 10: UPDATING TEST CASES CSV"
          echo "================================================"

          npm run update:csv -- \
            --csv "test-suites/${{ needs.explore-and-generate.outputs.test-suite-name }}-test-cases.csv" \
            --results "test-results/results.json"

          echo ""

      - name: ğŸ’¾ Commit Results
        run: |
          git config user.name "Test Reporter"
          git config user.email "reporter@github.com"

          git add test-suites/ reports/ analysis/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update test results for ${{ needs.explore-and-generate.outputs.test-suite-name }} - Updated CSV with Pass/Fail/Flaky - Generated HTML report - Run #${{ github.run_number }}"
            git push
            echo "âœ“ Results committed"
          fi

      - name: ğŸ“¤ Upload Final Report
        uses: actions/upload-artifact@v4
        with:
          name: final-report-${{ env.TIMESTAMP }}
          path: reports/
          retention-days: 90

      - name: ğŸ‰ Pipeline Complete
        run: |
          echo ""
          echo "================================================"
          echo "ğŸ‰ PIPELINE COMPLETED SUCCESSFULLY"
          echo "================================================"
          echo ""
          echo "ğŸ“‹ Summary:"
          echo "   - Test Suite: ${{ needs.explore-and-generate.outputs.test-suite-name }}"
          echo "   - Website: ${{ env.WEBSITE_URL }}"
          echo "   - CSV: Updated with results"
          echo "   - Report: Generated"
          echo "   - Analysis: Complete"
          echo ""
          echo "âœ… All 10 steps completed"
          echo ""
          echo "ğŸ“‚ Artifacts:"
          echo "   - Test Results: test-results-${{ env.TIMESTAMP }}"
          echo "   - Final Report: final-report-${{ env.TIMESTAMP }}"
