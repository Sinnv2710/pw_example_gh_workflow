name: QA Test Suite

on:
  # Run blocker tests on pull requests
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]
  
  # Run full suite on push to main
  push:
    branches: [ main ]
  
  # Nightly full test suite at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'
  
  # Allow manual workflow dispatch with options
  workflow_dispatch:
    inputs:
      test_level:
        description: 'Test level to run'
        required: true
        default: 'all'
        type: choice
        options:
          - blocker
          - critical
          - high
          - medium
          - low
          - all
      timeout:
        description: 'Timeout in seconds'
        required: false
        default: '300'

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Job 1: Blocker tests (runs on PRs for fast feedback)
  blocker-tests:
    name: Blocker Tests (PR Gate)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-test.txt
      
      - name: Run blocker tests
        id: blocker-tests
        run: |
          pytest tests/blocker/ \
            -v \
            --junitxml=test-results/blocker-junit.xml \
            --html=test-results/blocker-report.html \
            --self-contained-html \
            --timeout=60
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TEST_REPO_OWNER: ${{ secrets.TEST_REPO_OWNER }}
          TEST_REPO_NAME: ${{ secrets.TEST_REPO_NAME }}
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blocker-test-results
          path: test-results/
          retention-days: 30
      
      - name: Publish test results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Blocker Test Results
          path: test-results/blocker-junit.xml
          reporter: java-junit
          fail-on-error: true
      
      - name: Comment PR with results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const testResults = fs.existsSync('test-results/blocker-junit.xml');
            const status = '${{ steps.blocker-tests.outcome }}';
            const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
            
            const comment = `
            ## ${emoji} Blocker Test Results
            
            **Status:** ${status.toUpperCase()}
            **Test Level:** Blocker (PR Gate)
            **Duration:** ${{ steps.blocker-tests.outputs.duration || 'N/A' }}
            
            ${status === 'success' 
              ? '‚úÖ All blocker tests passed! Safe to merge.' 
              : '‚ùå Blocker tests failed. Please fix before merging.'}
            
            [View detailed results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Job 2: Full test suite (nightly and on-demand)
  full-test-suite:
    name: Full Test Suite - ${{ matrix.test-level }}
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix:
        test-level: [blocker, critical, high, medium, low]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-test.txt
      
      - name: Run ${{ matrix.test-level }} tests
        id: run-tests
        run: |
          # Create test results directory
          mkdir -p test-results coverage-reports
          
          # Run tests with coverage
          pytest tests/${{ matrix.test-level }}/ \
            -v \
            --cov \
            --cov-report=xml:coverage-reports/${{ matrix.test-level }}-coverage.xml \
            --cov-report=html:coverage-reports/${{ matrix.test-level }}-html \
            --junitxml=test-results/${{ matrix.test-level }}-junit.xml \
            --html=test-results/${{ matrix.test-level }}-report.html \
            --self-contained-html \
            --timeout=${{ github.event.inputs.timeout || '300' }} \
            -n auto
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TEST_REPO_OWNER: ${{ secrets.TEST_REPO_OWNER }}
          TEST_REPO_NAME: ${{ secrets.TEST_REPO_NAME }}
        continue-on-error: ${{ matrix.test-level != 'blocker' }}
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.test-level }}-test-results
          path: test-results/
          retention-days: 30
      
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.test-level }}-coverage
          path: coverage-reports/
          retention-days: 30
      
      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: coverage-reports/${{ matrix.test-level }}-coverage.xml
          flags: ${{ matrix.test-level }}
          name: ${{ matrix.test-level }}-coverage
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      
      - name: Publish test results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: ${{ matrix.test-level }} Test Results
          path: test-results/${{ matrix.test-level }}-junit.xml
          reporter: java-junit
          fail-on-error: ${{ matrix.test-level == 'blocker' }}

  # Job 3: Test summary and aggregation
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [full-test-suite]
    if: always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: all-test-results/
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Generate test summary
        run: |
          echo "# üìä QA Test Suite Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Test Results by Priority" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Priority | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          
          for level in blocker critical high medium low; do
            if [ -d "all-test-results/${level}-test-results" ]; then
              status="‚úÖ Passed"
            else
              status="‚ùå Failed"
            fi
            echo "| ${level} | ${status} | [View Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìà Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Coverage reports have been uploaded to Codecov." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîó Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Test Documentation](./docs/custom-agent-qa-test-cases-enhanced.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Execution Tracking](./tracking/test-execution-tracking.csv)" >> $GITHUB_STEP_SUMMARY
          echo "- [Test Fixtures](./fixtures/sample-problem-statements.md)" >> $GITHUB_STEP_SUMMARY
      
      - name: Check for blocker failures
        run: |
          if [ ! -d "all-test-results/blocker-test-results" ]; then
            echo "‚ùå Blocker tests failed!"
            exit 1
          fi
          echo "‚úÖ All blocker tests passed"

  # Job 4: Security scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Upload Trivy results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-security-results
          path: trivy-results.sarif
          retention-days: 30
